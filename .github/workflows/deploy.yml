name: Generate and Deploy rss.json

on:
  schedule:
    # 每天定时运行：0点、6点、12点、18点、21点（UTC时间）
    - cron: '0 0,6,12,18,21 * * *'
  # 允许手动触发
  workflow_dispatch:

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 检出代码
      - name: Checkout repository
        uses: actions/checkout@v3
      
      # 安装Rust
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      # 检查目录结构并构建项目
      - name: Check directory structure and build project
        run: |
          echo "当前工作目录: $(pwd)"
          ls -la
          if [ -f "Cargo.toml" ]; then
            echo "找到Cargo.toml，开始构建..."
            cargo build --release
          else
            echo "错误：未找到Cargo.toml文件"
            exit 1
          fi
      
      # 配置环境变量（可选，用于RSS源等敏感信息）
      - name: Configure environment
        run: |
          # 这里可以添加配置环境变量的命令
          echo "配置完成"
      
      # 运行程序生成rss.json
      - name: Generate rss.json
        run: |
          cargo run
      
      # 验证rss.json文件是否生成
      - name: Verify rss.json
        run: |
          if [ -f "rss.json" ]; then
            echo "rss.json 生成成功"
            ls -la rss.json
          else
            echo "rss.json 生成失败"
            exit 1
          fi
      
      # 将rss.json部署到服务器
      # 方法1：使用SCP（需要配置SSH密钥）
      # - name: Deploy to server via SCP
      #   uses: appleboy/scp-action@master
      #   with:
      #     host: ${{ secrets.SERVER_HOST }}
      #     username: ${{ secrets.SERVER_USERNAME }}
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     port: ${{ secrets.SERVER_PORT || '22' }}
      #     source: simple_edition/rss.json
      #     target: ${{ secrets.DEPLOY_PATH || '/var/www/html' }}
      #     overwrite: true
      
      # 方法2：使用SFTP（如果服务器支持）
      # - name: Deploy to server via SFTP
      #   uses: wlixcc/SFTP-Deploy-Action@v1.2.4
      #   with:
      #     username: ${{ secrets.SERVER_USERNAME }}
      #     server: ${{ secrets.SERVER_HOST }}
      #     ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     local_path: simple_edition/rss.json
      #     remote_path: ${{ secrets.DEPLOY_PATH || '/var/www/html' }}
      
      # 方法3：使用curl上传到API端点
      # - name: Upload data.json to API
      #   run: |
      #     curl -X POST \
      #       -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
      #       -F "file=@simple_edition/rss.json" \
      #       ${{ secrets.API_ENDPOINT }}
      
      # 通知（可选）
      - name: Send notification
        if: success() || failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_TITLE: "RSS.json Deployment"
          SLACK_MESSAGE: ${{ job.status == 'success' && '部署成功！' || '部署失败！' }}
          SLACK_COLOR: ${{ job.status == 'success' && 'good' || 'danger' }}
